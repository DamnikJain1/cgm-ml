  trigger:
    batch: true
    branches:
      include:
      - test-pipeline

  jobs:
  - job: EvaluationJob
    timeoutInMinutes: 300
    cancelTimeoutInMinutes: 2

    pool:
      vmImage: 'Ubuntu-16.04'

    steps:
    - script: echo Hello, Test Pipeline!
      displayName: 'TestPipeline for cgm-ml-service'
    
    - bash: |
        cd tests
        ls -l
        source /usr/share/miniconda/etc/profile.d/conda.sh
        which conda
        conda env create -f environment.yml
        conda env list
        jupyter kernelspec list
        conda activate CGMEvaluationPipeline
        conda list
        conda list | grep nbconvert
        conda list | grep papermill
        jupyter kernelspec list
      displayName: 'Environment Creation'
    
    - bash: |
        echo Login Azure Account
        az login -t $(sptenent) --service-principal -u $(spidentity) --password $(spsecret)
        az account set --subscription $(subscriptionid)
      displayName: 'Azure Login'
    
      - bash: |
        cd tests
        ls -l
        source /usr/share/miniconda/etc/profile.d/conda.sh
        conda activate CGMEvaluationPipeline
        python auth.py -sid $(subscriptionid) -rg $(RESOURCE_GROUP) -wn $(WORKSPACE_NAME) -tid $(sptenent) -spid $(spidentity) -sppwd $(spsecret)
        echo Executing evaluation.ipynb
        papermill evaluation.ipynb evaluation_Output.ipynb --log-output --no-progress-bar -k python3
      displayName: 'Run Evaluation'
